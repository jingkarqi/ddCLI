# ddcli 项目需求文档

## 1. 项目概述

ddcli 是一个命令行工具，允许用户通过自然语言描述其意图，由远程云端大语言模型（LLM）将其自动转换为准确、安全的终端命令并执行。目标是降低终端使用门槛，提升开发者和系统管理员的工作效率，同时保障系统安全。

用户只需输入类似 `dd "列出当前目录下所有文件并按大小排序"` 的命令，ddcli 即可调用云端模型生成对应的 `ls -lS` 命令并执行（或在确认后执行）。

## 2. 核心目标

- **自然语言交互**：用户用日常语言描述任务，无需记忆复杂命令。
- **安全优先**：默认不自动执行高危命令（如 rm、chmod 777 等），需用户显式确认。
- **可解释性**：清晰展示模型生成的命令及执行逻辑。
- **低延迟响应**：优化网络与模型调用流程，提升用户体验。
- **平台支持**：支持 Windows（PowerShell 5.1/7.x 兼容）。
- **技术选型**：采用nodejs开发，主要使用TypeScript编写,支持用户使用npm install安装

## 3. 功能需求

### 3.1 基本命令格式

```bash
dd <自然语言描述>
```

示例：
```bash
dd "创建一个名为 logs 的目录"
dd "查找所有 .py 文件中包含 'TODO' 的行"
dd "压缩当前目录为 backup.tar.gz"
```

### 3.2 核心功能

| 功能 | 描述 |
|------|------|
| **自然语言解析** | 将用户输入的自然语言发送至云端 LLM，返回对应的 shell 命令。 |
| **命令预览** | 默认先显示生成的命令，询问用户是否执行（可配置为自动执行）。 |
| **高危命令拦截** | 对潜在危险命令（如 rm、format、dd、chmod 777、sudo 等）强制要求确认。 |
| **上下文感知** | 可选支持会话上下文（如记住当前目录、最近操作），提升命令准确性。 |
| **多 Shell 支持** | 自动识别用户 Shell（bash/zsh/fish/powershell）并生成对应语法。 |
| **离线降级** | 网络不可用时提示错误，不提供服务（因本地模型难以保证准确性）。 |

### 3.3 安全机制

- **默认不自动执行**：首次使用需用户确认行为模式（交互式 or 自动执行）。
- **危险命令白名单/黑名单**：
  - 黑名单命令（如 `rm -rf /`, `:(){ :|:& };:`）直接拒绝执行。
  - 高风险命令（含 `sudo`, `rm`, `mv`, `dd`, `mkfs` 等）必须二次确认。
- **输出脱敏**：避免在日志或错误信息中泄露敏感命令内容。
- **API 密钥管理**：用户需配置自己的 API Key（支持主流云模型平台）。

### 3.4 配置与自定义

- 支持配置文件 `~/.ddcli/config.yaml`，包含：
  ```yaml
  model: "gpt-4o"  # 或 claude-3-5-sonnet, qwen-max 等
  provider: "openai"  # openai / anthropic / alibaba / custom
  api_key: "sk-xxxx"
  auto_execute: false  # 是否自动执行（默认 false）
  shell: "auto"        # auto / bash / zsh / powershell
  timeout: 10          # 模型请求超时（秒）
  ```

---

## 4. 非功能需求

| 类别 | 要求 |
|------|------|
| **性能** | 从输入到显示命令建议 ≤ 2 秒（95% 请求） |
| **可靠性** | 网络异常时优雅降级，不崩溃 |
| **可维护性** | 模块化设计，便于更换模型后端 |

---

## 5. 技术架构（概要）

```
[用户终端] 
    ↓ (dd "自然语言")
[ddcli CLI 工具]
    ↓ (封装请求)
[远程 LLM API] ←→ [Prompt 工程模板]
    ↓ (返回 JSON: {"command": "ls -l", "explanation": "列出详细信息"})
[ddcli CLI]
    → 显示命令 + 说明
    → 用户确认后执行（subprocess）
```

**Prompt 设计要点**：
- 明确指示只输出安全、可执行的 shell 命令。
- 要求附带简短解释。
- 禁止虚构命令或使用不存在的工具。
- 根据用户 Shell 类型调整语法。

## 6. 用户体验流程

1. 用户输入：`dd "把所有 .log 文件移动到 backup 目录"`
2. ddcli 调用云端模型，获取响应：
   ```json
   {
     "command": "mkdir -p backup && mv *.log backup/",
     "explanation": "先创建 backup 目录（如果不存在），然后移动所有 .log 文件"
   }
   ```
3. 终端显示：
   ```
   将执行命令：
     mkdir -p backup && mv *.log backup/
   说明：先创建 backup 目录（如果不存在），然后移动所有 .log 文件
   [Y/n]?
   ```
4. 用户输入 `Y` 后执行命令，输出结果。

---

> **备注**：本工具旨在辅助用户，**不替代对终端命令的理解**。建议用户始终审查生成的命令后再执行。

开源协议：MIT License